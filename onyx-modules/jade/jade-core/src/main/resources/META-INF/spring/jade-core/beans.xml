<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:tx="http://www.springframework.org/schema/tx" xmlns:aop="http://www.springframework.org/schema/aop"
  xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd">

  <tx:annotation-driven transaction-manager="transactionManager" />
  
  <bean name="consentDependency" class="org.obiba.onyx.engine.ConsentStageDependencyCondition">
    <property name="stageName" value="CON" />
  </bean>
  <bean name="staDependency" class="org.obiba.onyx.jade.engine.state.JadeStageDependencyCondition">
    <property name="instrumentService" ref="instrumentService" />
    <property name="instrumentRunService" ref="instrumentRunService" />
    <property name="queryService" ref="persistenceManager" />
    <property name="stageName" value="STA" />
  </bean>

  <bean id="jadeOnyxModule" class="org.obiba.onyx.jade.engine.JadeModule">
    <property name="activeInterviewService" ref="activeInterviewService" />
    <property name="stages">
      <list>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="STA" />
          <property name="module" value="jade" />
          <property name="description" value="Height_Measurement" />
          <property name="displayOrder" value="2" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition" ref="consentDependency" />
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="SIT" />
          <property name="module" value="jade" />
          <property name="description" value="Sitting_Height_Measurement" />
          <property name="displayOrder" value="3" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition" ref="consentDependency" />
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="HWC" />
          <property name="module" value="jade" />
          <property name="description" value="Hips_and_Waist_Size_Measurement" />
          <property name="displayOrder" value="4" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition" ref="consentDependency" />
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="MUS" />
          <property name="module" value="jade" />
          <property name="description" value="Grip_Strength_Measurement" />
          <property name="displayOrder" value="5" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition" ref="consentDependency" />
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="BIM" />
          <property name="module" value="jade" />
          <property name="description" value="Weight_and_Bioimpedance_Measurement" />
          <property name="displayOrder" value="6" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition">
            <bean class="org.obiba.onyx.engine.MultipleStageDependencyCondition">
              <property name="leftStageDependencyCondition" ref="consentDependency" />
              <property name="operator" value="AND" />
              <property name="rightStageDependencyCondition" ref="staDependency" />
            </bean>
          </property>
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="WEI" />
          <property name="module" value="jade" />
          <property name="description" value="Weight_Measurement" />
          <property name="displayOrder" value="7" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition">
            <bean class="org.obiba.onyx.engine.MultipleStageDependencyCondition">
              <property name="leftStageDependencyCondition" ref="consentDependency" />
              <property name="operator" value="AND" />
              <property name="rightStageDependencyCondition">
                <bean class="org.obiba.onyx.engine.InverseStageDependencyCondition">
                  <property name="stageDependencyCondition">
                    <bean class="org.obiba.onyx.jade.engine.state.JadeStageDependencyCondition">
                      <property name="instrumentService" ref="instrumentService" />
                      <property name="instrumentRunService" ref="instrumentRunService" />
                      <property name="queryService" ref="persistenceManager" />
                      <property name="stageName" value="BIM" />
                    </bean>
                  </property>
                </bean>
              </property>
            </bean>
          </property>
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="SPI" />
          <property name="module" value="jade" />
          <property name="description" value="Spirometry_Measurement" />
          <property name="displayOrder" value="8" />
          <property name="userSessionService" ref="userSessionService" />

          <property name="stageDependencyCondition">
            <!-- CON && STA && (BIM || WEI) -->
            <bean class="org.obiba.onyx.engine.MultipleStageDependencyCondition">
              <property name="leftStageDependencyCondition" ref="consentDependency" />
              <property name="operator" value="AND" />
              <property name="rightStageDependencyCondition">
                <bean class="org.obiba.onyx.engine.MultipleStageDependencyCondition">
                  <property name="leftStageDependencyCondition" ref="staDependency" />
                  <property name="operator" value="AND" />
                  <property name="rightStageDependencyCondition">
                    <bean class="org.obiba.onyx.engine.MultipleStageDependencyCondition">
                      <property name="leftStageDependencyCondition">
                        <bean class="org.obiba.onyx.jade.engine.state.JadeStageDependencyCondition">
                          <property name="instrumentService" ref="instrumentService" />
                          <property name="instrumentRunService" ref="instrumentRunService" />
                          <property name="queryService" ref="persistenceManager" />
                          <property name="stageName" value="BIM" />
                        </bean>
                      </property>
                      <property name="operator" value="OR" />
                      <property name="rightStageDependencyCondition">
                        <bean class="org.obiba.onyx.jade.engine.state.JadeStageDependencyCondition">
                          <property name="instrumentService" ref="instrumentService" />
                          <property name="instrumentRunService" ref="instrumentRunService" />
                          <property name="queryService" ref="persistenceManager" />
                          <property name="stageName" value="WEI" />
                        </bean>
                      </property>
                    </bean>
                  </property>
                </bean>
              </property>
            </bean>
          </property>
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="ECG" />
          <property name="module" value="jade" />
          <property name="description" value="Electrocardiogram_Measurement" />
          <property name="displayOrder" value="9" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition" ref="consentDependency" />
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="BON" />
          <property name="module" value="jade" />
          <property name="description" value="Bone_Density_Measurement" />
          <property name="displayOrder" value="10" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition" ref="consentDependency" />
        </bean>
        <bean class="org.obiba.onyx.engine.Stage">
          <property name="name" value="ART" />
          <property name="module" value="jade" />
          <property name="description" value="Arterial_Stiffness_Measurement" />
          <property name="displayOrder" value="10" />
          <property name="userSessionService" ref="userSessionService" />
          <property name="stageDependencyCondition" ref="consentDependency" />
        </bean>
      </list>
    </property>
  </bean>

  <bean id="jadeWaitingState" parent="baseStageState" class="org.obiba.onyx.jade.engine.state.JadeWaitingState"
    scope="prototype">
  </bean>

  <bean id="jadeReadyState" parent="baseStageState" class="org.obiba.onyx.jade.engine.state.JadeReadyState"
    scope="prototype">
  </bean>

  <bean id="jadeNotApplicableState" parent="baseStageState"
    class="org.obiba.onyx.jade.engine.state.JadeNotApplicableState" scope="prototype">
  </bean>
  
  <bean id="jadeContraIndicatedState" parent="baseStageState"
    class="org.obiba.onyx.jade.engine.state.JadeContraIndicatedState" scope="prototype">
  </bean>

  <bean id="jadeInProgressState" parent="baseStageState" class="org.obiba.onyx.jade.engine.state.JadeInProgressState"
    scope="prototype">
    <property name="activeInstrumentRunService" ref="activeInstrumentRunService" />
  </bean>

  <bean id="jadeSkippedState" parent="baseStageState" class="org.obiba.onyx.jade.engine.state.JadeSkippedState"
    scope="prototype">
  </bean>

  <bean id="jadeCompletedState" parent="baseStageState" class="org.obiba.onyx.jade.engine.state.JadeCompletedState"
    scope="prototype">
  </bean>

  <bean id="instrumentService" class="org.obiba.onyx.jade.core.service.impl.DefaultInstrumentServiceImpl">
    <property name="persistenceManager" ref="persistenceManager" />
    
  </bean>

  <bean id="activeInstrumentRunService"
    class="org.obiba.onyx.jade.core.service.impl.DefaultActiveInstrumentRunServiceImpl" scope="session">
    <property name="persistenceManager" ref="persistenceManager" />
    <property name="userSessionService" ref="userSessionService" />    
  </bean>

  <bean id="instrumentDescriptorService"
    class="org.obiba.onyx.jade.core.service.impl.DefaultInstrumentDescriptorServiceImpl" />

  <bean id="inputDataSourceVisitor" class="org.obiba.onyx.jade.core.service.impl.InputDataSourceVisitorImpl"
    scope="prototype">
    <property name="queryService" ref="persistenceManager" />
    <property name="instrumentRunService" ref="instrumentRunService" />
  </bean>

  <bean id="jadeDatabaseSeed" class="org.obiba.onyx.jade.core.wicket.seed.JadeDatabaseSeed" scope="singleton">
    <property name="resourcePatterns">
      <list>
        <value>instruments/instrumentTypes-descriptor.xml</value>
        <value>instruments/**/instrument-descriptor.xml</value>
      </list>
    </property>
    <property name="persistenceManager" ref="persistenceManager" />
    <property name="instrumentService" ref="instrumentService" />
    <property name="instrumentDescriptorService" ref="instrumentDescriptorService" />
  </bean>


</beans>