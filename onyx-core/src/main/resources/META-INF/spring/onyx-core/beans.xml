<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:context="http://www.springframework.org/schema/context"
  xmlns:tx="http://www.springframework.org/schema/tx" xmlns:aop="http://www.springframework.org/schema/aop"
  xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd
http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd
http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd">

  <import resource="version.xml" />
  <import resource="batch.xml"/>

  <bean name="version" class="org.obiba.runtime.Version" primary="true">
    <constructor-arg value="${project.version}-b${buildNumber}" />
  </bean>

  <bean name="actionDefinitionConfiguration" class="org.obiba.onyx.engine.ActionDefinitionConfiguration">
    <property name="onyxConfigPath" value="${org.obiba.onyx.config.path}" />
  </bean>

  <bean id="interviewManager" class="org.obiba.onyx.core.service.impl.DefaultInterviewManagerImpl">
    <property name="persistenceManager" ref="persistenceManager" />
    <property name="userSessionService">
      <bean class="org.springframework.aop.scope.ScopedProxyFactoryBean">
        <property name="targetBeanName" value="userSessionService" />
      </bean>
    </property>
  </bean>
    
  <bean id="interviewService" class="org.obiba.onyx.core.service.impl.DefaultInterviewServiceImpl">
    <property name="persistenceManager" ref="persistenceManager" />
  </bean>
  
  <bean id="appointmentManagementService" class="org.obiba.onyx.core.service.impl.DefaultAppointmentManagementServiceImpl" init-method="initialize">
    <property name="persistenceManager" ref="persistenceManager" />
    <property name="inputDirectory" value="${org.obiba.onyx.appointments.inputDirectory}" />
    <property name="outputDirectory" value="${org.obiba.onyx.appointments.outputDirectory}" />
    <property name="jobLauncher" ref="jobLauncher" />
    <property name="jobExplorer" ref="jobExplorer"/>
    <property name="job" ref="appointmentListUpdateJob" />
  </bean>
  
  <bean id="stageExecutionContext" class="org.obiba.onyx.engine.state.StageExecutionContext" scope="prototype">
    <property name="persistenceManager" ref="persistenceManager" />
    <property name="moduleRegistry" ref="moduleRegistry" />
    <property name="userSessionService" ref="userSessionService" />
  </bean>

  <bean id="appConfigService" class="org.obiba.onyx.core.service.impl.DefaultApplicationConfigurationServiceImpl">
    <property name="persistenceManager" ref="persistenceManager" />
  </bean>

  <bean id="moduleRegistry" class="org.obiba.onyx.engine.ModuleRegistry">
    <property name="stageOrderingStrategy" ref="stageOrderingStrategy" />
  </bean>

  <bean id="activeInterviewService" class="org.obiba.onyx.core.service.impl.DefaultActiveInterviewServiceImpl" scope="session" destroy-method="shutdown">
    <property name="persistenceManager" ref="persistenceManager" />
    <property name="interviewManager" ref="interviewManager" />
    <property name="userSessionService" ref="userSessionService" />
    <property name="moduleRegistry" ref="moduleRegistry" />
    <aop:scoped-proxy proxy-target-class="false" />
  </bean>

  <bean id="moduleRegistrationListener" class="org.obiba.onyx.engine.ModuleRegistrationListener">
    <property name="moduleRegistry" ref="moduleRegistry" />
    <property name="variableDirectory" ref="variableDirectory" />
  </bean>

  <bean id="variableDirectory" class="org.obiba.onyx.engine.variable.VariableDirectory">
    <property name="variablePathNamingStrategy" ref="variablePathNamingStrategy" />
  </bean>

  <bean id="baseStageState" class="org.obiba.onyx.engine.state.AbstractStageState" abstract="true">
    <property name="activeInterviewService" ref="activeInterviewService" />
    <property name="actionDefinitionConfiguration" ref="actionDefinitionConfiguration" />
  </bean>

  <bean id="participantMetadata" class="org.obiba.onyx.core.domain.participant.ParticipantMetadata">
    <property name="participantIdPattern" value="${org.obiba.onyx.participantId.pattern}" />
    <property name="onyxConfigPath" value="${org.obiba.onyx.config.path}" />
    <property name="supportedRecruitmentTypesString" value="${org.obiba.onyx.supportedRecruitmentTypes}" />
  </bean>

  <bean id="pdfPrintingService" class="org.obiba.onyx.print.PdfPrintingService">
    <property name="printerName" value="${org.obiba.onyx.pdfPrinterName}" />
  </bean>

  <bean id="onyxVariableProvider" class="org.obiba.onyx.engine.variable.OnyxVariableProvider">
    <property name="participantMetadata" ref="participantMetadata" />
    <property name="participantService" ref="participantService" />
    <property name="applicationConfigurationService" ref="appConfigService" />
    <property name="version" ref="version" />
    <property name="variableHelper" ref="variableHelper" />
    <property name="moduleRegistry" ref="moduleRegistry" />
    <property name="interviewService" ref="interviewService" />
    <property name="stageInstanceAlgorithm" ref="stageInstanceAlgorithm" />
  </bean>

  <bean id="onyxKeyStore" class="org.obiba.onyx.crypt.OnyxKeyStore" init-method="open" destroy-method="close">
    <property name="keyStoreResource" value="${org.obiba.onyx.keystore.file}" />
    <property name="keyStorePassword" value="${org.obiba.onyx.keystore.password}" />
  </bean>

  <bean id="onyxDataExportDestinations" class="org.obiba.onyx.engine.variable.export.OnyxDataExportFactoryBean">
    <property name="destinationsResource" value="${org.obiba.onyx.config.path}/export-destinations.xml" />
  </bean>

  <bean id="algorithmEvaluator" class="org.obiba.onyx.math.impl.MathEclipseEvaluator">
  </bean>
  
  <bean id="hashingService" class="org.obiba.onyx.core.service.impl.MessageDigestPasswordHashingStrategyImpl" init-method="validateAlgorithm">
    <property name="algorithm" value="${org.obiba.onyx.password.hash.algorithm}" />
  </bean>
  
  <bean id="passwordLengthValidationStrategy" class="org.obiba.onyx.core.service.impl.AbstractPasswordLengthValidationStrategy" abstract="true">
    <property name="minimumSize" ref="${org.obiba.onyx.password.validation.minimumSize}" />
    <property name="maximumSize" ref="${org.obiba.onyx.password.validation.maximumSize}" />
  </bean>
  
  <bean id="validationStrategy" class="org.obiba.onyx.core.service.impl.ConfigurablePasswordValidationStrategyImpl"  init-method="validateCharacterGroups">
    <property name="allowedCharacterGroups" value="${org.obiba.onyx.password.validation.allowedCharacterGroups}" />
    <property name="minimumCharacterGroupsUsage" value="${org.obiba.onyx.password.validation.minimumCharacterGroupsUsage}" />
    <property name="preventUserAttributeUsage" value="${org.obiba.onyx.password.validation.preventUserAttributeUsage}" />
  </bean>
    
  <bean id="pdfTemplateEngine" class="org.obiba.onyx.print.impl.DefaultPdfTemplateEngine" scope="session">
    <property name="dateFormat" value="${org.obiba.onyx.dateFormat}" />
    <property name="variableDirectory" ref="variableDirectory" />    
  </bean>    
  
  <bean id="printableReportsRegistry" class="org.obiba.onyx.print.impl.DefaultPrintableReportsRegistry" scope="session">
  </bean> 

  <bean id="variableHelper" class="org.obiba.onyx.engine.variable.VariableHelper">
  </bean> 
  
  <bean id="configurableVariableProviderFactory" class="org.obiba.onyx.engine.variable.configurable.ConfigurableVariableFactoryBean" scope="singleton">
    <property name="resourcePatterns">
      <list>
        <value>${org.obiba.onyx.config.path}/configurable-variables.xml</value>
      </list>
    </property>
  </bean>
    
  <bean id="experimentalConditionService" class="org.obiba.onyx.core.service.impl.DefaultExperimentalConditionServiceImpl">
    <property name="persistenceManager" ref="persistenceManager" />
    <property name="sessionFactory" ref="sessionFactory" />
  </bean>

  <bean id="experimentalConditionFactory" class="org.obiba.onyx.core.domain.condition.ExperimentalConditionFactory" init-method="registerExperimentalConditions">
    <property name="experimentalConditionService" ref="experimentalConditionService" />
    <property name="resourcePatterns">
      <list>
        <value>${org.obiba.onyx.config.path}/jade/experimental-conditions.xml</value>
      </list>
    </property>
  </bean>

  <bean id="stageInstanceAlgorithm" class="org.obiba.onyx.core.domain.stage.DefaultStageInstanceAlgorithm" />
  
</beans>
